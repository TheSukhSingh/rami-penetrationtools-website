{% extends 'auth/auth_base.html' %}
{% block title %}Reset Password{% endblock %}
{% block content %}
<main>
  <div class="auth-container">
    <div class="auth-card">
      <h2>Set a New Password</h2>
      <p class="auth-subtext">Choose a strong password and confirm it below.</p>

      {# Flash messages (from server) #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, msg in messages %}
              <div class="flash {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form id="resetForm"
            class="auth-form"
            method="POST"
            action="{{ url_for('auth.reset_password', token=token) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {# Hidden context for client-side checks only #}
        <input type="hidden" id="ctx_name"     value="{{ (user.name or '')|e }}">
        <input type="hidden" id="ctx_username" value="{{ (user.username or '')|e }}">
        <input type="hidden" id="ctx_email"    value="{{ (user.email or '')|e }}">

        <div class="form-group">
          <label for="password">New Password</label>
          <div class="pw-input-wrapper" style="position:relative">
            <input type="password"
                   id="password"
                   name="password"
                   required
                   autocomplete="new-password">
            <button type="button"
                    class="password-toggle"
                    aria-label="Show password"
                    data-target="password"
                    style="position:absolute;right:.5rem;top:.45rem">
              <span class="eye-open">👁️</span>
              <span class="eye-closed" style="display:none">🙈</span>
            </button>
          </div>

          <!-- strength checklist -->
          <div id="pwRules" class="pw-rules" style="margin:.5rem 0 0 .25rem; font-size:12px; line-height:1.6;">
            <div data-rule="len">• at least 8 characters</div>
            <div data-rule="upper">• at least 1 uppercase letter</div>
            <div data-rule="digit">• at least 1 digit</div>
            <div data-rule="special">• at least 1 special character</div>
            <div data-rule="repeat">• no character repeated 3× in a row</div>
            <div data-rule="personal">• must not contain your name/username/email</div>
          </div>

          <!-- generator -->
          <div class="pw-gen" style="margin-top:.5rem; display:flex; gap:.5rem; align-items:center;">
            <button type="button" id="genStrong" class="btn small">Generate strong</button>
            <input type="text" id="genOutput" readonly placeholder="generated password will appear here"
                   style="flex:1; min-width:200px;">
            <button type="button" id="useGenerated" class="btn small">Use</button>
          </div>
        </div>

        <div class="form-group">
          <label for="confirm_password">Confirm Password</label>
          <div class="pw-input-wrapper" style="position:relative">
            <input type="password"
                   id="confirm_password"
                   name="confirm_password"
                   required
                   autocomplete="new-password">
            <button type="button"
                    class="password-toggle"
                    aria-label="Show password"
                    data-target="confirm_password"
                    style="position:absolute;right:.5rem;top:.45rem">
              <span class="eye-open">👁️</span>
              <span class="eye-closed" style="display:none">🙈</span>
            </button>
          </div>
          <div id="matchMsg" style="font-size:12px;margin-top:.25rem;"></div>
        </div>

        <button type="submit" class="btn auth-btn" id="submitBtn">Reset Password</button>
      </form>

      <div class="auth-footer">
        <p>Remembered your password? <a href="{{ url_for('auth.login_page') }}">Sign in</a></p>
      </div>
    </div>
  </div>
</main>

<!-- Optional meta token if you ever AJAX this page -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<script>
(function () {
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const name = ($("#ctx_name")?.value || "").toLowerCase();
  const username = ($("#ctx_username")?.value || "").toLowerCase();
  const emailLocal = ($("#ctx_email")?.value || "").split("@")[0]?.toLowerCase() || "";

  function mark(rule, ok) {
    const el = document.querySelector('#pwRules [data-rule="'+rule+'"]');
    if (!el) return;
    el.style.color = ok ? "#00d98b" : "#ff6b6b";
  }

  function validatePassword(pw) {
    const lower = pw.toLowerCase();
    const okLen = pw.length >= 8;
    const okUpper = /[A-Z]/.test(pw);
    const okDigit = /\d/.test(pw);
    const okSpecial = /[^A-Za-z0-9]/.test(pw);
    const okRepeat = !/(.)\1\1/.test(pw);

    const needles = [name, username, emailLocal].filter(s => s && s.length >= 3);
    const okPersonal = !needles.some(s => lower.includes(s));

    mark("len", okLen);
    mark("upper", okUpper);
    mark("digit", okDigit);
    mark("special", okSpecial);
    mark("repeat", okRepeat);
    mark("personal", okPersonal);

    return okLen && okUpper && okDigit && okSpecial && okRepeat && okPersonal;
  }

  function togglePassword(btn) {
    const targetId = btn.dataset.target;
    const input = document.getElementById(targetId);
    const open = btn.querySelector(".eye-open");
    const closed = btn.querySelector(".eye-closed");
    if (input.type === "password") {
      input.type = "text";
      if (open) open.style.display = "none";
      if (closed) closed.style.display = "inline";
    } else {
      input.type = "password";
      if (open) open.style.display = "inline";
      if (closed) closed.style.display = "none";
    }
  }

  // generator ensuring at least one from each class + avoiding personal info
  function generateStrong(len = 12) {
    const U = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    const L = "abcdefghjkmnpqrstuvwxyz";
    const D = "23456789";
    const S = "!@#$%^&*()-_=+[]{};:,.?";
    const all = U + L + D + S;

    function pick(str) { return str[Math.floor(Math.random()*str.length)]; }
    function shuffle(a){
      for (let i=a.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.join("");
    }

    let pw;
    do {
      const req = [pick(U), pick(L), pick(D), pick(S)];
      const rest = Array.from({length: Math.max(len - req.length, 0)}, () => pick(all));
      pw = shuffle(req.concat(rest));
    } while (!validatePassword(pw));
    return pw;
  }

  // wire up
  $$(".password-toggle").forEach(btn => {
    btn.addEventListener("click", () => togglePassword(btn));
  });

  const pw = $("#password");
  const cpw = $("#confirm_password");
  const matchMsg = $("#matchMsg");
  const submitBtn = $("#submitBtn");

  function update() {
    const strong = validatePassword(pw.value);
    const match = pw.value && cpw.value && pw.value === cpw.value;
    matchMsg.textContent = match ? "Passwords match ✓" : (cpw.value ? "Passwords do not match" : "");
    matchMsg.style.color = match ? "#00d98b" : "#ff6b6b";
    submitBtn.disabled = !(strong && match);
  }

  pw.addEventListener("input", update);
  cpw.addEventListener("input", update);
  update();

  $("#genStrong")?.addEventListener("click", () => {
    const g = generateStrong(14);
    $("#genOutput").value = g;
  });

  $("#useGenerated")?.addEventListener("click", () => {
    const g = $("#genOutput").value || generateStrong(14);
    pw.value = g;
    cpw.value = g;
    update();
  });

  $("#resetForm").addEventListener("submit", (e) => {
    // Final guard (server also validates)
    if (submitBtn.disabled) {
      e.preventDefault();
    }
  });
})();
</script>
{% endblock %}
